<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wildsoft.shopping_mall.shop.ShopDao">

  <!-- 상품 -->
  <select id="getProductList"
    parameterType="com.wildsoft.shopping_mall.shop.ProductVO"
    resultType="com.wildsoft.shopping_mall.shop.ProductVO">
      <![CDATA[
        select rnum, q.*
        from (
          select
            row_number() over (order by product_id desc) as rnum,
            k.*
          from (
            select * from products where 1=1
      ]]>
      <if test="search_type == 'product_name'">
      <![CDATA[
            and product_name like concat('%', #{search_value}, '%')
      ]]>
      </if>
      <if test="search_type == 'category'">
      <![CDATA[
            and category like concat('%', #{search_value}, '%')
      ]]>
      </if>
      <if test="search_type == 'created_at'">
        <choose>
          <when test="date_search_type == 'year'">
            <![CDATA[
              and YEAR(created_at) = #{search_value}
            ]]>
          </when>
          <when test="date_search_type == 'month'">
            <![CDATA[
              and MONTH(created_at) = #{search_value}
            ]]>
          </when>
          <when test="date_search_type == 'day'">
            <![CDATA[
              and DAY(created_at) = #{search_value}
            ]]>
          </when>
          <otherwise>
            <![CDATA[
              and DATE(created_at) = DATE(#{search_value})
            ]]>
          </otherwise>
        </choose>
      </if>
      <![CDATA[
          ) k
        ) q
        where rnum between #{start} and #{end}
      ]]>
  </select>

	<select id="getProductsCount" resultType="int">
    select count(*) as total_count from products
  </select>

  <select id="getProduct" 
    parameterType="com.wildsoft.shopping_mall.shop.ProductVO"
    resultType="com.wildsoft.shopping_mall.shop.ProductVO">
      select * from products where product_id = #{product_id}
  </select>

  <insert id="insertProduct" parameterType="com.wildsoft.shopping_mall.shop.ProductVO">
    insert into products (product_name, product_description, product_price, stock_quantity, category)
    values (#{product_name}, #{product_description}, #{product_price}, #{stock_quantity}, #{category})
  </insert>

  <update id="updateProduct" parameterType="com.wildsoft.shopping_mall.shop.ProductVO">
    update products
    <set>
      <if test="product_name != null">product_name = #{product_name},</if>
      <if test="product_description != null">product_description = #{product_description},</if>
      <if test="product_price != 0">product_price = #{product_price},</if>
      <if test="stock_quantity != 0">stock_quantity = #{stock_quantity},</if>
      <if test="category != null">category = #{category},</if>
    </set>
    where product_id = #{product_id}
  </update>

  <delete id="deleteProduct" parameterType="com.wildsoft.shopping_mall.shop.ProductVO">
    delete from products where product_id = #{product_id}
  </delete>

  <!-- 장바구니 -->
  <select id="getCartList" 
    parameterType="com.wildsoft.shopping_mall.shop.CartVO"
    resultType="com.wildsoft.shopping_mall.shop.CartVO">
      select id, cart_id, product_id, product_price, quantity, 
      (quantity * product_price) as total_price, created_at, updated_at
      from carts where id = #{id}
  </select>

  <select id="findCartItem" 
    parameterType="com.wildsoft.shopping_mall.shop.CartVO"
    resultType="com.wildsoft.shopping_mall.shop.CartVO">
      select * from carts where id = #{id} and product_id = #{product_id}
  </select>

  <insert id="insertCart" parameterType="com.wildsoft.shopping_mall.shop.CartVO">
    insert into carts (id, product_id, product_price, quantity)
    values (#{id}, #{product_id}, #{product_price}, #{quantity})
  </insert>

  <update id="updateCart" parameterType="com.wildsoft.shopping_mall.shop.CartVO">
    update carts set quantity = #{quantity}
    where id = #{id} and product_id = #{product_id}
  </update>

  <delete id="deleteCart" parameterType="com.wildsoft.shopping_mall.shop.CartVO">
    delete from carts where id = #{id} and product_id = #{product_id}
  </delete>

  <delete id="deleteCartAll" parameterType="com.wildsoft.shopping_mall.shop.CartVO">
    delete from carts where id = #{id}
  </delete>

  <!-- 주문하기 -->
  <insert id="insertOrder" parameterType="com.wildsoft.shopping_mall.shop.OrderVO">
    insert into orders (order_id, id, product_id, quantity, total_price, shipping_fee, shipping_address)
    values (#{id}, #{product_id}, #{product_price}, #{quantity})
  </insert>
</mapper>